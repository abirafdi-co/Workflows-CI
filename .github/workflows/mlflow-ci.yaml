name: MLflow CI - Retrain on Trigger

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      push_docker:
        description: "Build & push Docker image to Docker Hub (Advanced)"
        required: false
        default: "false"

jobs:
  train:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    env:
      MLFLOW_TRACKING_URI: file:${{ github.workspace }}/mlruns

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Miniconda (Python 3.12)
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          python-version: "3.12"
          activate-environment: ml_training_env

      - name: Create env from conda.yaml
        run: |
          conda env remove -n ml_training_env -y || true
          conda env create -n ml_training_env -f MLProject/conda.yaml
          conda activate ml_training_env
          python --version
          mlflow --version

      - name: Run MLflow Project (re-train)
        run: |
          conda activate ml_training_env
          # Run the MLflow Project located in ./MLProject
          mlflow run MLProject \
            -P data_path="telco_preprocessing" \
            -P model_name="model_ci" \
            -P test_size=0.2 \
            -P random_state=42

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts
          path: |
            MLProject/artifacts
            mlruns

      - name: Log in to Docker Hub
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.push_docker == 'true' }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build Docker image for the trained MLflow model
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.push_docker == 'true' }}
        run: |
          conda activate ml_training_env

          # Find latest run_id (works for local file store)
          latest_run_id=$(ls -1t mlruns/*/*/meta.yaml 2>/dev/null | head -n 1 | awk -F'/' '{print $(NF-1)}')
          echo "Latest run_id: ${latest_run_id}"

          # Build image from the logged model artifact (without MLServer for compatibility)
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/telco-churn-mlflow:latest
          mlflow models build-docker -m "runs:/${latest_run_id}/model" -n "${IMAGE_NAME}"

      - name: Push Docker image to Docker Hub
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.push_docker == 'true' }}
        run: |
          IMAGE_NAME=${{ secrets.DOCKERHUB_USERNAME }}/telco-churn-mlflow:latest
          docker push "${IMAGE_NAME}"

      - name: Test Model Inference 
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.push_docker == 'true' }}
        run: |
          conda activate ml_training_env
          # Pull and test the image
          docker pull "${IMAGE_NAME}"
          docker run -d -p 5001:8080 --name test-model "${IMAGE_NAME}"
          sleep 10
          # Test inference with sample data
          curl -X POST http://localhost:5001/invocations -H "Content-Type: application/json" -d '{"inputs": [0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0]}'
          docker stop test-model
          docker rm test-model

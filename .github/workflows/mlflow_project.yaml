name: MLflow Project CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  MLFLOW_TRACKING_URI: https://dagshub.com/abirafdi-co/Membangun_model.mlflow
  MLFLOW_EXPERIMENT_NAME: telco_churn_ci

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-activate-base: false
          activate-environment: ml_telco_churn_env
          environment-file: MLProject/conda.yaml

      - name: Install MLflow & DagsHub
        shell: bash -l {0}
        run: |
          pip install --upgrade pip
          pip install mlflow dagshub scikit-learn pandas numpy

      - name: Run MLflow Project
        shell: bash -l {0}
        working-directory: MLProject
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
        run: |
          mlflow run . | tee mlflow_output.txt

      - name: Get latest MLflow run id
        shell: bash -l {0}
        working-directory: MLProject
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
          MLFLOW_EXPERIMENT_NAME: ${{ env.MLFLOW_EXPERIMENT_NAME }}
        run: |
          python - << 'PY'
          import os
          import mlflow
          from mlflow.tracking import MlflowClient

          mlflow.set_tracking_uri(os.environ["MLFLOW_TRACKING_URI"])
          exp_name = os.environ["MLFLOW_EXPERIMENT_NAME"]

          exp = mlflow.get_experiment_by_name(exp_name)
          if exp is None:
              raise SystemExit(f"Experiment '{exp_name}' tidak ditemukan. Pastikan modelling.py set_experiment('{exp_name}').")

          client = MlflowClient()
          runs = client.search_runs(
              experiment_ids=[exp.experiment_id],
              order_by=["attributes.start_time DESC"],
              max_results=1,
          )
          if not runs:
              raise SystemExit(f"Tidak ada run ditemukan di experiment '{exp_name}' setelah mlflow run .")

          run_id = runs[0].info.run_id
          print("RUN_ID:", run_id)

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"RUN_ID={run_id}\n")
          PY

      - name: Build Docker Image
        shell: bash -l {0}
        working-directory: MLProject
        env:
          MLFLOW_TRACKING_URI: ${{ env.MLFLOW_TRACKING_URI }}
        run: |
          echo "Building from RUN_ID=$RUN_ID"
          mlflow models build-docker --model-uri "runs:/$RUN_ID/model" --name "telco-churn-ci"

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Tag & Push Image
        shell: bash -l {0}
        run: |
          docker tag telco-churn-ci ${{ secrets.DOCKER_USERNAME }}/telco-churn-ci:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/telco-churn-ci:latest
